<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comptes 18 ans Nalya</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="La Caisse">

    <link rel="apple-touch-icon" href="icon-caisse.png?v=5">
    <link rel="icon" type="image/png" href="icon-caisse.png?v=5">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --pink: #ff7eb9;
            --purple: #764ba2;
            --dark: #2d3436;
            --white: #ffffff;
            --gradient: linear-gradient(135deg, #ff7eb9 0%, #764ba2 100%);
        }

        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; color: var(--dark); margin: 0; padding: 15px; padding-top: 60px; /* Espace pour le bouton retour */ }
        
        /* Bouton Retour */
        .btn-back {
            position: fixed; top: 15px; left: 15px; z-index: 10000; 
            background: rgba(255,255,255,0.8); color: var(--purple); 
            padding: 8px 15px; border-radius: 20px; text-decoration: none; 
            font-size: 0.8rem; font-weight: 600; backdrop-filter: blur(5px); 
            border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container { max-width: 500px; margin: 0 auto; }
        .hero-mini { background: var(--gradient); color: white; padding: 20px; text-align: center; border-radius: 20px; margin-bottom: 20px; }
        .hero-mini h1 { margin: 0; font-size: 1.4rem; }
        .sync-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; display: inline-block; margin-top: 5px; }
        .card { background: var(--white); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--purple); margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-family: inherit; margin-bottom: 15px; font-size: 1rem; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; background: var(--gradient); color: white; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 15px rgba(255, 126, 185, 0.3); }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .expense-info b { display: block; color: var(--dark); }
        .expense-info small { color: #a2a2a2; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; font-size: 0.65rem; }
        .amt { font-weight: 700; color: var(--purple); }
        .delete-btn { color: #ff7675; margin-left: 15px; cursor: pointer; opacity: 0.6; }
        .total-box { text-align: center; padding: 20px; background: #fff5f9; border-radius: 15px; margin: 15px 0; }
        .total-box div { font-size: 1.5rem; font-weight: 800; color: var(--pink); }
        .debt-card { background: #f1f2f6; padding: 15px; border-radius: 15px; }
        .debt-line { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 0.9rem; }
        .debt-line i { color: var(--pink); }
    </style>
</head>
<body>

<div class="container">
    <div class="hero-mini">
        <h1>ðŸ’° LA CAISSE</h1>
        <span class="sync-badge"><i class="fas fa-sync-alt fa-spin"></i> Synchronisation en direct</span>
    </div>

    <div class="card">
        <label>Objet du paiement</label>
        <input type="text" id="desc" placeholder="Ex: Billets RER">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Montant (â‚¬)</label>
                <input type="number" id="amount" step="0.01" placeholder="0.00">
            </div>
            <div style="flex: 1;">
                <label>PayÃ© par</label>
                <select id="payer">
                    <option value="Antonin">Antonin</option>
                    <option value="Ethan">Ethan</option>
                    <option value="Lise">Lise</option>
                </select>
            </div>
        </div>
        <button onclick="addExpense()">Ajouter la dÃ©pense</button>
    </div>

    <div class="card">
        <h2 style="font-size: 1rem; margin-top:0;">DÃ‰PENSES PARTAGÃ‰ES</h2>
        <div id="expenseList"><small>Chargement des donnÃ©es...</small></div>

        <div class="total-box">
            <small>TOTAL DÃ‰PENSÃ‰</small>
            <div id="totalDisplay">0.00 â‚¬</div>
            <small id="shareDisplay">Soit 0.00 â‚¬ / pers.</small>
        </div>

        <div id="summaryDisplay" class="debt-card">
            Les calculs s'afficheront ici.
        </div>
    </div>
</div>

<script type="module">
    // Importation des fonctions Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    // Ta configuration rÃ©cupÃ©rÃ©e
    const firebaseConfig = {
        apiKey: "AIzaSyAFLWY9tfylYTPoe0-s2OgjD_5I5sDW5os",
        authDomain: "comptesnalya.firebaseapp.com",
        databaseURL: "https://comptesnalya-default-rtdb.firebaseio.com",
        projectId: "comptesnalya",
        storageBucket: "comptesnalya.firebasestorage.app",
        messagingSenderId: "135143379852",
        appId: "1:135143379852:web:2ae4d250cc973ed9207ca9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const expenseRef = ref(db, 'expenses');

    // Fonction pour ajouter (disponible globalement)
    window.addExpense = function() {
        const desc = document.getElementById('desc').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const payer = document.getElementById('payer').value;

        if (desc && !isNaN(amount)) {
            push(expenseRef, {
                desc: desc,
                amount: amount,
                payer: payer,
                timestamp: Date.now()
            });
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
        } else {
            alert("Remplis bien tous les champs !");
        }
    };

    // Fonction pour supprimer
    window.deleteExpense = function(id) {
        if(confirm("Supprimer cette dÃ©pense ?")) {
            remove(ref(db, 'expenses/' + id));
        }
    };

    // Lecture en temps rÃ©el
    onValue(expenseRef, (snapshot) => {
        const data = snapshot.val();
        render(data);
    });

    function render(data) {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        let total = 0;
        let balances = { "Antonin": 0, "Ethan": 0, "Lise": 0 };

        if (!data) {
            list.innerHTML = "<p style='text-align:center; color:#ccc;'>Aucune dÃ©pense pour le moment.</p>";
            document.getElementById('totalDisplay').innerText = "0.00 â‚¬";
            document.getElementById('summaryDisplay').innerHTML = "Rien Ã  rembourser.";
            return;
        }

        Object.keys(data).forEach(id => {
            const e = data[id];
            total += e.amount;
            balances[e.payer] += e.amount;
            
            list.innerHTML += `
                <div class="expense-item">
                    <div class="expense-info">
                        <b>${e.desc}</b>
                        <small>${e.payer}</small>
                    </div>
                    <div>
                        <span class="amt">${e.amount.toFixed(2)}â‚¬</span>
                        <i class="fas fa-trash delete-btn" onclick="deleteExpense('${id}')"></i>
                    </div>
                </div>
            `;
        });

        const share = total / 3;
        document.getElementById('totalDisplay').innerText = total.toFixed(2) + " â‚¬";
        document.getElementById('shareDisplay').innerText = "Soit " + share.toFixed(2) + " â‚¬ par personne";

        // Calcul des dettes (Qui doit quoi)
        let debts = [];
        let members = ["Antonin", "Ethan", "Lise"];
        let status = members.map(name => ({
            name: name,
            balance: balances[name] - share
        }));

        // Algorithme simplifiÃ© de remboursement
        let sorted = status.sort((a, b) => a.balance - b.balance);
        let i = 0;
        let j = sorted.length - 1;

        let debtHTML = "";
        while (i < j) {
            let payeur = sorted[i];
            let receveur = sorted[j];
            let montant = Math.min(-payeur.balance, receveur.balance);

            if (montant > 0.01) {
                debtHTML += `
                    <div class="debt-line">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span><b>${payeur.name}</b> doit <b>${montant.toFixed(2)}â‚¬</b> Ã  ${receveur.name}</span>
                    </div>`;
            }

            payeur.balance += montant;
            receveur.balance -= montant;

            if (payeur.balance === 0) i++;
            if (receveur.balance === 0) j--;
        }

        document.getElementById('summaryDisplay').innerHTML = debtHTML || "Tout est Ã©quilibrÃ© !";
    }
</script>

</body>
</html>